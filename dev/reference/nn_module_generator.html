<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Generalized Neural Network Module Expression Generator — nn_module_generator • kindling</title><!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png"><link rel="icon" type="”image/svg+xml”" href="../favicon.svg"><link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png"><link rel="icon" sizes="any" href="../favicon.ico"><link rel="manifest" href="../site.webmanifest"><!-- katex math --><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css" integrity="sha384-nB0miv6/jRmo5UMMR1wu3Gz6NLsoTkbqJghGIsx//Rlm+ZU03BU6SQNC66uf4l5+" crossorigin="anonymous"><script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js" integrity="sha384-7zkQWkzuo3B5mTepMUcHkMB5jZaolc2xDwL6VFqjFALcbeS9Ggm/Yr2r3Dy4lfFg" crossorigin="anonymous"></script><script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js" integrity="sha384-43gviWU0YVjaDtb/GhzOouOXtZMP/7XUzwPTstBeZFe/+rCMvRwr4yROQP43s0Xk" crossorigin="anonymous" onload="renderMathInElement(document.body);"></script><script src="../katex-auto.js"></script><script src="../lightswitch.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Playfair_Display-0.4.10/font.css" rel="stylesheet"><link href="../deps/Fira_Mono-0.4.10/font.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Generalized Neural Network Module Expression Generator — nn_module_generator"><meta name="description" content="
nn_module_generator() is a generalized function that generates neural network
module expressions for various architectures. It provides a flexible framework for creating
custom neural network modules by parameterizing layer types, construction arguments, and
forward pass behavior.
While designed primarily for {torch} modules, it can work with custom layer implementations
from the current environment, including user-defined layers like RBF networks, custom
attention mechanisms, or other novel architectures.
This function serves as the foundation for specialized generators like ffnn_generator()
and rnn_generator(), but can be used directly to create custom architectures."><meta property="og:description" content="
nn_module_generator() is a generalized function that generates neural network
module expressions for various architectures. It provides a flexible framework for creating
custom neural network modules by parameterizing layer types, construction arguments, and
forward pass behavior.
While designed primarily for {torch} modules, it can work with custom layer implementations
from the current environment, including user-defined layers like RBF networks, custom
attention mechanisms, or other novel architectures.
This function serves as the foundation for specialized generators like ffnn_generator()
and rnn_generator(), but can be used directly to create custom architectures."><meta property="og:image" content="https://kindling.joshuamarie.com/logo.png"><meta name="robots" content="noindex"></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top " aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">kindling</a>

    <small class="nav-text text-default me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">0.2.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item"><a class="nav-link" href="../articles/kindling.html">Get started</a></li>
<li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="../articles/kindling.html">Getting Started</a></li>
    <li><a class="dropdown-item" href="../articles/similar-packages.html">Similar packages and comparison</a></li>
    <li><a class="dropdown-item" href="../articles/tuning-capabilities.html">Tuning Capabilities</a></li>
  </ul></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-learn-more" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Learn more</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-learn-more"><li><a class="external-link dropdown-item" href="https://www.tidymodels.org/learn/models/parsnip-ranger-glmnet/">Regression modeling</a></li>
    <li><a class="external-link dropdown-item" href="https://www.tidymodels.org/learn/models/parsnip-nnet/">Classification modeling</a></li>
  </ul></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/joshuamarie/kindling" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-lightswitch" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true" aria-label="Light switch"><span class="fa fa-sun"></span></button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-lightswitch"><li><button class="dropdown-item" data-bs-theme-value="light"><span class="fa fa-sun"></span> Light</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="dark"><span class="fa fa-moon"></span> Dark</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="auto"><span class="fa fa-adjust"></span> Auto</button></li>
  </ul></li>
<li class="nav-item"><a class="external-link nav-link" href="https://joshuamarie.com"><span class="fa fa-blog"></span> Blog</a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Generalized Neural Network Module Expression Generator</h1>
      <small class="dont-index">Source: <a href="https://github.com/joshuamarie/kindling/blob/main/R/torch_code_gen.R" class="external-link"><code>R/torch_code_gen.R</code></a></small>
      <div class="d-none name"><code>nn_module_generator.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p><a href="https://lifecycle.r-lib.org/articles/stages.html#experimental" class="external-link"><img src="figures/lifecycle-experimental.svg" alt="[Experimental]"></a></p>
<p><code>nn_module_generator()</code> is a generalized function that generates neural network
module expressions for various architectures. It provides a flexible framework for creating
custom neural network modules by parameterizing layer types, construction arguments, and
forward pass behavior.</p>
<p>While designed primarily for <code>{torch}</code> modules, it can work with custom layer implementations
from the current environment, including user-defined layers like RBF networks, custom
attention mechanisms, or other novel architectures.</p>
<p>This function serves as the foundation for specialized generators like <code><a href="nn_gens.html">ffnn_generator()</a></code>
and <code><a href="nn_gens.html">rnn_generator()</a></code>, but can be used directly to create custom architectures.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">nn_module_generator</span><span class="op">(</span></span>
<span>  nn_name <span class="op">=</span> <span class="st">"nnModule"</span>,</span>
<span>  nn_layer <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  out_nn_layer <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  nn_layer_args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  layer_arg_fn <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  forward_extract <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  before_output_transform <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  after_output_transform <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  last_layer_args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  <span class="va">hd_neurons</span>,</span>
<span>  <span class="va">no_x</span>,</span>
<span>  <span class="va">no_y</span>,</span>
<span>  activations <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  output_activation <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  bias <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  eval <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  .env <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sys.parent.html" class="external-link">parent.frame</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  <span class="va">...</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-nn-name">nn_name<a class="anchor" aria-label="anchor" href="#arg-nn-name"></a></dt>
<dd><p>Character string specifying the name of the generated neural network module class.
Default is <code>"nnModule"</code>.</p></dd>


<dt id="arg-nn-layer">nn_layer<a class="anchor" aria-label="anchor" href="#arg-nn-layer"></a></dt>
<dd><p>The type of neural network layer to use. Can be specified as:</p><ul><li><p><code>NULL</code> (default): Uses <code>nn_linear()</code> from <code>{torch}</code></p></li>
<li><p>Character string: e.g., <code>"nn_linear"</code>, <code>"nn_gru"</code>, <code>"nn_lstm"</code>, <code>"some_custom_layer"</code></p></li>
<li><p>Named function: A function object that constructs the layer</p></li>
<li><p>Anonymous function: e.g., <code>\() nn_linear()</code> or <code>function() nn_linear()</code></p></li>
</ul><p>The layer constructor is first searched in the current environment, then in parent
environments, and finally falls back to the <code>{torch}</code> namespace. This allows you to
use custom layer implementations alongside standard torch layers.</p></dd>


<dt id="arg-out-nn-layer">out_nn_layer<a class="anchor" aria-label="anchor" href="#arg-out-nn-layer"></a></dt>
<dd><p>Default <code>NULL</code>. If supplied, it forces to be the neural network layer to be used
on the last layer. Can be specified as:</p><ul><li><p>Character string, e.g. <code>"nn_linear"</code>, <code>"nn_gru"</code>, <code>"nn_lstm"</code>, <code>"some_custom_layer"</code></p></li>
<li><p>Named function: A function object that constructs the layer</p></li>
<li><p>Formula interface, e.g. <code>~torch::nn_linear</code>, <code>~some_custom_layer</code></p></li>
</ul><p>Internally, it almost works the same as <code>nn_layer</code> parameter.</p></dd>


<dt id="arg-nn-layer-args">nn_layer_args<a class="anchor" aria-label="anchor" href="#arg-nn-layer-args"></a></dt>
<dd><p>Named list of additional arguments passed to the layer constructor
specified by <code>nn_layer</code>. These arguments are applied to all layers. For layer-specific
arguments, use <code>layer_arg_fn</code>. Default is an empty list.</p></dd>


<dt id="arg-layer-arg-fn">layer_arg_fn<a class="anchor" aria-label="anchor" href="#arg-layer-arg-fn"></a></dt>
<dd><p>Optional function or formula that generates layer-specific construction arguments.
Can be specified as:</p><ul><li><p><strong>Formula</strong>: <code>~ list(input_size = .in, hidden_size = .out)</code> where <code>.in</code>, <code>.out</code>, <code>.i</code>, and <code>.is_output</code> are available</p></li>
<li><p><strong>Function</strong>: <code>function(i, in_dim, out_dim, is_output)</code> with signature as before</p></li>
</ul><p>The formula/function should return a named list of arguments to pass to the layer constructor.
Available variables in formula context:</p><ul><li><p><code>.i</code> or <code>i</code>: Integer, the layer index (1-based)</p></li>
<li><p><code>.in</code> or <code>in_dim</code>: Integer, input dimension for this layer</p></li>
<li><p><code>.out</code> or <code>out_dim</code>: Integer, output dimension for this layer</p></li>
<li><p><code>.is_output</code> or <code>is_output</code>: Logical, whether this is the final output layer</p></li>
</ul><p>If <code>NULL</code>, defaults to FFNN-style arguments: <code>list(in_dim, out_dim, bias = bias)</code>.</p></dd>


<dt id="arg-forward-extract">forward_extract<a class="anchor" aria-label="anchor" href="#arg-forward-extract"></a></dt>
<dd><p>Optional formula or function that processes layer outputs in the forward pass.
Useful for layers that return complex structures (e.g., RNNs return <code>list(output, hidden)</code>).
Can be specified as:</p><ul><li><p><strong>Formula</strong>: <code>~ .[[1]]</code> or <code>~ .$output</code> where <code>.</code> represents the layer output</p></li>
<li><p><strong>Function</strong>: <code>function(expr)</code> that accepts/returns a language object</p></li>
</ul><p>Common patterns:</p><ul><li><p>Extract first element: <code>~ .[[1]]</code></p></li>
<li><p>Extract named element: <code>~ .$output</code></p></li>
<li><p>Extract with method: <code>~ .$get_output()</code></p></li>
</ul><p>If <code>NULL</code>, layer outputs are used directly.</p></dd>


<dt id="arg-before-output-transform">before_output_transform<a class="anchor" aria-label="anchor" href="#arg-before-output-transform"></a></dt>
<dd><p>Optional formula or function that transforms input before the output layer.
This is applied after the last hidden layer (and its activation) but before the output layer.
Can be specified as:</p><ul><li><p><strong>Formula</strong>: <code>~ .[, .$size(2), ]</code> where <code>.</code> represents the current tensor</p></li>
<li><p><strong>Function</strong>: <code>function(expr)</code> that accepts/returns a language object</p></li>
</ul><p>Common patterns:</p><ul><li><p>Extract last timestep: <code>~ .[, .$size(2), ]</code></p></li>
<li><p>Flatten: <code>~ .$flatten(start_dim = 1)</code></p></li>
<li><p>Global pooling: <code>~ .$mean(dim = 2)</code></p></li>
<li><p>Extract token: <code>~ .[, 1, ]</code></p></li>
</ul><p>If <code>NULL</code>, no transformation is applied.</p></dd>


<dt id="arg-after-output-transform">after_output_transform<a class="anchor" aria-label="anchor" href="#arg-after-output-transform"></a></dt>
<dd><p>Optional formula or function that transforms the output after the output layer.
This is applied after <code>self$out(x)</code> (the final layer) but before returning the result.
Can be specified as:</p><ul><li><p><strong>Formula</strong>: <code>~ .$mean(dim = 2)</code> where <code>.</code> represents the output tensor</p></li>
<li><p><strong>Function</strong>: <code>function(expr)</code> that accepts/returns a language object</p></li>
</ul><p>Common patterns:</p><ul><li><p>Global average pooling: <code>~ .$mean(dim = 2)</code></p></li>
<li><p>Squeeze dimensions: <code>~ .$squeeze()</code></p></li>
<li><p>Reshape output: <code>~ .$view(c(-1, 10))</code></p></li>
<li><p>Extract specific outputs: <code>~ .[, , 1:5]</code></p></li>
</ul><p>If <code>NULL</code>, no transformation is applied.</p></dd>


<dt id="arg-last-layer-args">last_layer_args<a class="anchor" aria-label="anchor" href="#arg-last-layer-args"></a></dt>
<dd><p>Optional named list or formula specifying additional arguments
for the output layer only. These arguments are appended to the output layer constructor
after the arguments from <code>layer_arg_fn</code>. Can be specified as:</p><ul><li><p><strong>Formula</strong>: <code>~ list(kernel_size = 2L, bias = FALSE)</code></p></li>
<li><p><strong>Named list</strong>: <code>list(kernel_size = 2L, bias = FALSE)</code></p></li>
</ul><p>This is useful when you need to override or add specific parameters to the final layer
without affecting hidden layers. For example, in CNNs you might want a different kernel
size for the output layer, or in RNNs you might want to disable bias in the final linear
projection. Arguments in <code>last_layer_args</code> will override any conflicting arguments from
<code>layer_arg_fn</code> when <code>.is_output = TRUE</code>. Default is an empty list.</p></dd>


<dt id="arg-hd-neurons">hd_neurons<a class="anchor" aria-label="anchor" href="#arg-hd-neurons"></a></dt>
<dd><p>Integer vector specifying the number of neurons (hidden units) in each
hidden layer. The length determines the number of hidden layers in the network.
Must contain at least one element.</p></dd>


<dt id="arg-no-x">no_x<a class="anchor" aria-label="anchor" href="#arg-no-x"></a></dt>
<dd><p>Integer specifying the number of input features (input dimension).</p></dd>


<dt id="arg-no-y">no_y<a class="anchor" aria-label="anchor" href="#arg-no-y"></a></dt>
<dd><p>Integer specifying the number of output features (output dimension).</p></dd>


<dt id="arg-activations">activations<a class="anchor" aria-label="anchor" href="#arg-activations"></a></dt>
<dd><p>Activation function specifications for hidden layers. Can be:</p><ul><li><p><code>NULL</code>: No activation functions applied</p></li>
<li><p>Character vector: e.g., <code>c("relu", "sigmoid", "tanh")</code></p></li>
<li><p><code>activation_spec</code> object: Created using <code><a href="act_funs.html">act_funs()</a></code>, which allows
specifying custom arguments. See examples.</p></li>
</ul><p>If a single activation is provided, it will be replicated across all hidden layers.
Otherwise, the length should match the number of hidden layers.</p></dd>


<dt id="arg-output-activation">output_activation<a class="anchor" aria-label="anchor" href="#arg-output-activation"></a></dt>
<dd><p>Optional activation function for the output layer.
Same format as <code>activations</code>, but should specify only a single activation.
Common choices include <code>"softmax"</code> for classification or <code>"sigmoid"</code> for
binary outcomes. Default is <code>NULL</code> (no output activation).</p></dd>


<dt id="arg-bias">bias<a class="anchor" aria-label="anchor" href="#arg-bias"></a></dt>
<dd><p>Logical indicating whether to include bias terms in layers.
Default is <code>TRUE</code>. Note that this is passed to <code>layer_arg_fn</code> if provided,
so custom layer argument functions should handle this parameter appropriately.</p></dd>


<dt id="arg-eval">eval<a class="anchor" aria-label="anchor" href="#arg-eval"></a></dt>
<dd><p>Logical indicating whether to evaluate the generated expression immediately.
If <code>TRUE</code>, returns an instantiated <code>nn_module</code> class that can be called directly
(e.g., <code>model()</code>). If <code>FALSE</code> (default), returns the unevaluated language expression
that can be inspected or evaluated later with <code><a href="https://rdrr.io/r/base/eval.html" class="external-link">eval()</a></code>. Default is <code>FALSE</code>.</p></dd>


<dt id="arg--env">.env<a class="anchor" aria-label="anchor" href="#arg--env"></a></dt>
<dd><p>Default is <code><a href="https://rdrr.io/r/base/sys.parent.html" class="external-link">parent.frame()</a></code>. The environment in which the generated expression is to be evaluated</p></dd>


<dt id="arg--">...<a class="anchor" aria-label="anchor" href="#arg--"></a></dt>
<dd><p>Additional arguments passed to layer constructors or for future extensions.</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p>If <code>eval = FALSE</code> (default): A language object (unevaluated expression) representing
a <code><a href="https://torch.mlverse.org/docs/reference/nn_module.html" class="external-link">torch::nn_module</a></code> definition. This expression can be evaluated with <code><a href="https://rdrr.io/r/base/eval.html" class="external-link">eval()</a></code> to
create the module class, which can then be instantiated with <code>eval(result)()</code> to
create a model instance.</p>
<p>If <code>eval = TRUE</code>: An instantiated <code>nn_module</code> class constructor that can be called
directly to create model instances (e.g., <code>result()</code>).</p>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>

    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Joshua Marie.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a>. Visit my <a href="https://joshuamarie.com" class="external-link">blog</a> for more content.</p>
</div>

    </footer></div>





  </body></html>

